FC-510 history:

Видео: http://www.youtube.com/watch?v=VNKCnef-ynU

Version 0.7

Fref = 12.8 МГц
10-битный счетчик интерполятора

Version 0.8

Fref = 100 МГц (PLL)
8-битный счетчик интерполятора

? Выбор Fref. При Fref = 100 MHz интерполятор
  работает не очень хорошо, показывает значения,
  по модулю меньше нужных. Непонятно, какой вклад
  вносит джиттер измеряемого сигнала.
  На практике той точности, которую обеспечивает
  Fref = 12.8 MHz, вполне достаточно.
  Применение PLL с VCO 100 MHz - это усложнение схемы,
  добавление джиттера (как минимум, в роли VCO должен
  быть VCXO), схема с трудом умещается в EPM3064
  (разные режимы работы не влезут).
+ Fref = 12.8 МГц

? Согласование выхода TCXO со входами.
  Похоже, TCXO имеет на выходе разделительный
  конденсатор. Прямое тактирование CPLD не
  получается. Тактирование CPU тоже не очень:
  процессор работает (режим генератора - HF XTAL
  Full Amplitude), но с XTAL2 плохо тактируется
  CPLD.
+ На выходе TCXO установить буферный усилитель
  ОЭ-ОБ на BFT93. Это универсальное решение, будет
  работать со всеми генераторами. С выхода усилителя
  сигнал на CPLD. В CPLD предусмотреть выход
  тактовой частоты Fcpu = Fref/1, Fref/2, Fref/4,
  Fref/8. Это позволит использовать любой TCXO
  вплоть до 100 MHz.

? Нужно ли пропускать PulseIn интерполятора
  через дополнительный LCELL?
- Никакого эффекта не замечено. Возможно,
  чуть-чуть лучше, но на грани заметности.

? Уменьнение шума калибровочного коэффициента.
+ Сделал функцию, которая позволяет проводить
  калибровку N раз. Поставил N = 10,
  калибровочный коэффициент сейчас гораздо
  стабильнее.

? Делать ли второй интерполятор для измерения
  интервалов?
- Нет. Не в этой модели.
  Интервалы измерять без интерполяции,
  хотя при больших длительностях интерполятор
  можно использовать.

- Плохо работает буфер (низкий коэффициент передачи,
  при этом появляется смещение, зависящее от формы
  входного сигнала).
+ Исправил заменой JFET. Для норальной работы буфера
  нужен транзистор с начальным током стока
  5 - 10 мА и напряжением отсечки 2 - 4 В.
  Напряжение на выходе OP777 должно быть -0.5..-2 В.

- Повышенный уровень помех на выходе буфера.
+ Это помехи ключевого стабилизатора источника
  питания. Из-за неудачной точки заземления
  инвертора (удвоителя) напряжения помехи по
  земле проникали на уровень -5 В. Транзистор,
  регулирующий ток JFET, можно представить
  как каскад с ОБ, усиливающий пульсации на
  шине -5 В и передающий их на выход.
  Изменил точку заземления удвоителя.
  Добавил LC фильтр (56 uH + 4.7 uF x 25 V) перед 79L05.
  Увеличил дроссель LM2576 до 470 uH (был 100 uH).
- Применить в источнике питания LM2596 и побольше
  дросселя на выходе.
  На входе основной платы добавить электролиты +
  керамика.
+ Или применить линейный источник питания, что лучше
  всего, потребление ведь незначительное.
+ Потребление по +5 В составляет 110 мА (90 мА без
  входной платы), по -5 В - 18 мА.

- Ложные срабатывания компаратора на медленно
  меняющемся сигнале.
+ Увеличил гистерезис до 85 мВ (резистор ПОС 56 К).
  Добавил резистор 120 К для симметрирования гистерезиса.

? Почему-то для импульсного сигнала порог чувствительности
  100 мВ, а по теории должен быть 170 мВ.
  Выбросы на фронтах?

- Защитный диод с малыми утечками BAV199,
  маркировка JY* (p, t)
  Не смог найти, пока установил BAV99.

- Поменять обозначения M и N в документации согласно документу
  Agilent.

- Сделать вариант статической индикации на 74HC595 + LED.

Version 1.0

  Работала у меня 5 лет в частотомере с прошивкой Ver10.
  Только измерение частоты, есть делитель Fcpu.

Version1.1

+ Altera: убрал делитель тактовой частоты для CPU.

+ Altera: на выход SData вывожу не FrefGate, а FinGate.

+ Altera: задействовал сигналы Mode. Теперь выход FinGate поступает
  на d-вход FrefGate через мультиплексор. В зависимости от значения
  Mode по логике "И" добавляется либо Fin, либо !Fin. Это позволяет
  с помощью счетчика FrefCnt считать длительность только единиц
  или только нулей в серии входных импульсов. Таким образом можно
  сделать измерение th и tl.

- Измерение длительности импульсов.
+ Реализовал заполнением Fref по серии импульсов внутри Gate.
  Заполняется суммарная длительность единиц (нулей),
  результат делится на кол-во импульсов.
? Что удивительно, нормально измеряются импульсы от 10 нс.

- Предусмотреть режим измерения дрейфа (отклонения) частоты.
+ Реализовал режим dF.

- Auto Range.
+ Реализовал.

- Ограничение количества значащих цифр в зависимости от времени
  измерения?
? Зачем?

- Счет событий MODE_N сделать на таймере микроконтроллера.
  Для этого в Altera на выход QFin включать непосредственно
  сигнал Fin. Обновление дисплея делать в процессе счета
  по таймеру. Счет будет возможен до 6.4 МГц.
- Пока не делал за ненужностью.

- Счет времени в воротах MODE_GC можно реализовать так: ворота
  делаются в Altera, на выход QRef во время ворот поступает
  частота, например, 10 мкс (Fclk/128). Счет времени делать таймером
  микроконтроллера. Обновление дисплея делать в процессе счета.
- Пока не делал за ненужностью.

- Режимы прямого и обратного таймеров реализовать только на
  микроконтроллере.
? Необходимость обратного таймера под вопросом.
  Как ему задавать начальное значение?
- Пока не делал за ненужностью.

Version1.2

+ Изменил алгоритм масштабирования показаний. Теперь частота
  вычисляется для всех режимов и хранится в единицах 100 мкГц.
  Это позволило корректно выводить статистику.

- Задать PAR_PRE_NOM таким, как у внешнего делителя (когда
  будет известно).

? Нужен ли порт на PC?
- Да. Хотя бы в простейшем варианте,
  типа "F 50,000.000 kHz" <Cr><Lf> 

? Защиту на прескалер диоды?
  На входе BF960, BF998 для получения 1 МОм.

- Предусмотреть подключение LCD 1601

Version1.3

+ Минус теперь вывожу перед числом, а не вместо самой левой
  цифры числа.

+ Добавил ограничение для отрицательных чисел.

+ Исправил масштабирование для отрицательных чисел.

+ Добавил по кнопке "MENU" выход из HOLD
  без сброса статистики.

Version1.4

+ Добавлены две конфигурации для компиляции:
  LCD10 (дисплей MT-10T7 или MT-10T8) и
  LCD16 (дисплей 1601).
? Адресация символов 1 строка 16 или 2 строки по 8?
  Пока отлажено на дисплее 1602.

+ В варианте LCD16 добавлена поддержка последовательного
  порта. В порт передается копия дисплея в ASCII.

? Наблюдается погрешность при измерении периода и длительности
  импульсов на временах порядка сотен мс. Дело в том, что
  частота внутри представлена в сотнях микрогерц (при измерении
  периода и длительности расчет ведется тоже через эквивалентную
  частоту).
+ Внес изменения в модуль Count.c. В режимах MODE_HI, MODE_LO и
  MODE_P вычисляется не частота, а сразу период, который
  сохраняется в той же переменной Freq. В режимах
  MODE_HI и MODE_LO интерполятор не используется.

- Перенести работу с UART в отдельный модуль, чтобы порт
  работал с любым индикатором.

- Сделать внешний прескалер с входом 50 Ом на LMX2322 + ATtiny13.
+ Сделал.

+ Настройка частотомера:
  В первую очередь нужно измерить напряжение на выходе ОУ U1,
  когда на входе нет никакого сигнала. Оно должно быть около
  -0.5..-2 В. Если напряжение сильно отличается, требуется
  замена полевого транзистора VT1. Подойдут экземпляры с
  начальным током стока  5 - 10 мА и напряжением отсечки 2 - 4 В.

  Подстроечные конденсаторы на входной плате служат для компенсации
  делителей и подстройки входной емкости прибора. Вообще,
  равномерность АЧХ для входного усилителя частотомера не является
  такой важной, как для осциллографа. Поэтому эти подстройки можно
  просто опустить. Но если есть желание, можно и подстроить. На вход
  нужно подать прямоугольные импульсы частотой, например, 1 кГц.
  Сигнал нужно контролировать осциллографом на эмиттере VT3.
  Сначала включить делитель 1:1. Подстроечным конденсатором C2
  добиться отсутствия выброса на фронте импульса.
  Если интересует точная входная емкость (это важно при использовании
  внешних щупов), то сигнал на вход подают через щуп со встроенным
  делителем 1:10 и подстройкой C6 добиваются отсутствия выброса.
  После регулировки C6 обычно требуется пропорциональная подстройка
  C2, поэтому нужно будет сделать несколько приближений.
  Затем на вход частотомера нужно подать сигнал непосредственно,
  включить делитель 1:10 и емкостью C4 добиться отсутствия выброса.

  Не помешает проверить шкалу интерполятора. Для этого нужно
  зайти в меню Int, интерполятор должен быть включен, показания
  должны быть 100±10. Если отклонение больше, то резистором R13
  на основной плате нужно их подкорректировать.

  Но самая главная регулировка частотомера - установка опорной
  частоты. На вход нужно подать сигнал образцовой частоты (например,
  сигнал 1PPS с приемника GPS или 5 - 10 МГц с термостатированного
  генератора) и подстроечным конденсатором генератора выставить
  номинальное значение показаний.

+ 16.08.2013 Исправил ошибку для индикатора 1602(01) при индикации
  частоты с учетом IF. Вместо "F с точкой" вывожу "f".

10.09.2013

+ Исправил формулу расчета частоты с учетом IF

+ Исправил округление отрицательных значений частоты

+ Добавил в 10 раз более быстрый автоповтор после 100 повторов
! При быстром автоповторе строка не успевает передаваться в порт.
  В принципе, не очень это и нужно, но некрасиво. Запретить
  передачу при быстром автоповторе? Или прореживать?

+ Увеличил шаг изменения IF до 1 кГц после ±1000.0 кГц

+ Добавил сброс параметров Gate, Average, IF, Prescaler на
  номинальные значения (1000, 1, 0 и 1 соответственно) при
  нажатии UP + DOWN.

13.11.2014 - Version1.7

+ Добавил три конфигурации компиляции: LCD10, LCD1601, LCD1602.
  Разделил модули работы с дисплеем на следующие части:
  Disp.c, Disp.h - общие функции работы с дисплеем. Здесь всегда
  формируется полная строка (как для LCD16XX). На дисплей LCD16XX
  она передается без каких-либо преобразований, а на дисплей
  LCD10 передается только название параметра и числовое значение,
  точки вместо отдельных знакомест добавляются к символам.
  Lcd16xx, Lcd.h - модуль поддержки дисплеев LCD16XX.
  Lcd10, Lcd.h - модуль поддержки дисплея LCD10.
  Заголовочный файл у них общий Lcd.h, интерфейс дисплеев сделан
  одинаковым.

+ Выделил работу с портом в отдельный модуль. Теперь порт доступен
  и в конфигурации с дисплеем LCD10. В порт отправляется полная
  строка (как для LCD16XX).

+ При передаче данных в порт добавлена проверка, закончилась ли
  предыдущая передача. Иначе при быстром автоповторе передавалась
  искаженная строка.

+ Добавил новый режим индикации FIF. Теперь для включения учета
  ПЧ нужно вместо F выбрать FIF. Для отключения учета ПЧ не требуется
  сбрасывать ее значение в 0, достаточно перейти к режиму индикации F.
